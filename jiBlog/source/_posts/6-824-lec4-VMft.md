---
title: 6.824-lec4-VMft
date: 2022-03-08 18:09:05
tags: 6.824
categories: Distributed System
---

<div></div>

<!--more-->

# Replicas

---

Following are just sth i think novel and hard to think of immediately.

## Two ways of replicate machines

1. **State transfer**
   * just a backup of state (e.g. RAM)

2. **Replicated State Machine **(unicore-machine only)
   * Start from the same state, only transfer the **input** to the backup from primary
     * Because the transition caused by the input from the same state is the same.

---

## Replicated State Machine

### Challenges

* What state?
  * All things in RAM and registers
* P/B sync
  * logging channel and log entry
    * **Backup only receives log entry ONLY from Primary, it drops clients' packets, EVEN the interrupt of physical machine**
    * Backup can not be ahead of Primary
      * Backup has a buffer storing the events Primary sent, and **ONLY IF** there exists at least an event can it start running.
* Cut-over (how)
* Anomolies always show up when machine fails
* New replicas is expensive

---

## Non-deterministic events

* Inputs <- packets
  * Packets -> data + an interrupt
    * We want to interrupt the primary and backup **at the same instruction**
      * use **SPECIAL INSTURTION** to interrupt cpu **at specified instruction number**
* **Weird instructions** 
  * getTimeOfDay(), random()
  * **send the result** of undeterministic instruction's result through logging channel
* **Multicore** parallelism

### Solution

* Log entry has 
  * **intruction number** (from startup)
  * type
  * data

---

## Output Rule

For synchronization, the sequence of output is

1. Client sends a increment to primary
2. Primary VMM sends it to guestOS and Backup
3. **When Primary GuestOS generates output, buffer it in VMM.**
4. When backup receives the Primary's log entry, buffers it in the entry buffer and sends an **ACK** to Primary
5. When the Primary receives the ACK, it is allowed to proceed to send the output generated by GuestO

---

## Network failure

If the primary and backup cannot talk to each other, they both think the other is dead and they should be live.

However, neither the machine is dead, and what if they can both talk to the clients.



The **solution** is to involve a outside authority.

When this situation happens, they both (if alive) send a **test-and-set** request to the authority (**JUST LIKE SPINLOCK**), only the first one acquires the authorization can become the new primary.
